{% extends './layout/default' %}

{% block content %}
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12">
        <div class="box">
            <div class="box-header with-border">
                <h3 class="box-title">
                    <span class="fa fa-plus-circle"></span>
                    {{ ('create_new_account')|_ }}
                </h3>
                <div class="box-tools pull-right">
                    <a href="{{ route('accounts.all') }}" class="btn btn-default btn-sm">
                        <span class="fa fa-arrow-left"></span>
                        {{ ('back_to_accounts')|_ }}
                    </a>
                </div>
            </div>
            <div class="box-body">
                <p class="text-muted">
                    {{ ('choose_account_template_description')|_ }}
                </p>

                <!-- Search and Filter Controls -->
                <div class="row" style="margin-bottom: 20px;">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="search">{{ ('search_templates')|_ }}</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   placeholder="{{ ('search_by_name_or_description')|_ }}" 
                                   value="{{ search }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="category">{{ ('filter_by_category')|_ }}</label>
                            <select class="form-control" id="category" name="category">
                                <option value="">{{ ('all_categories')|_ }}</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.name }}" {{ category == cat.name ? 'selected' : '' }}>
                                        {{ cat.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="account_type">{{ ('filter_by_type')|_ }}</label>
                            <select class="form-control" id="account_type" name="account_type">
                                <option value="">{{ ('all_types')|_ }}</option>
                                {% for type in accountTypes %}
                                    <option value="{{ type }}" {{ accountType == type ? 'selected' : '' }}>
                                        {{ type }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="sort">{{ ('sort_by')|_ }}</label>
                            <select class="form-control" id="sort" name="sort">
                                <option value="name" {{ sort == 'name' ? 'selected' : '' }}>{{ ('name')|_ }}</option>
                                <option value="category" {{ sort == 'category' ? 'selected' : '' }}>{{ ('category')|_ }}</option>
                                <option value="type" {{ sort == 'type' ? 'selected' : '' }}>{{ ('type')|_ }}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Results Summary -->
                {% if search or category or behavior %}
                    <div class="alert alert-info">
                        <span class="fa fa-info-circle"></span>
                        {{ ('showing_results_for')|_ }}: 
                        {% if search %}<strong>{{ search }}</strong>{% endif %}
                        {% if category %}{{ ('in_category')|_ }} <strong>{{ category }}</strong>{% endif %}
                        {% if behavior %}{{ ('of_type')|_ }} <strong>{{ behavior }}</strong>{% endif %}
                        ({{ templates|length }} {{ ('templates_found')|_ }})
                    </div>
                {% endif %}

                {% if templatesByCategory|length == 0 %}
                    <div class="alert alert-warning text-center">
                        <span class="fa fa-search"></span>
                        {{ ('no_templates_found')|_ }}
                        {% if search or category or behavior %}
                            <br><small>{{ ('try_adjusting_your_filters')|_ }}</small>
                        {% endif %}
                    </div>
                {% else %}
                    {% for categoryName, templates in templatesByCategory %}
                    <div class="row" style="margin-bottom: 30px;">
                        <div class="col-lg-12">
                            <h4 class="text-primary">
                                <span class="fa fa-{{ categoryName == 'Asset' ? 'money' : (categoryName == 'Liability' ? 'landmark' : 'chart-line') }}"></span>
                                {{ categoryName }} {{ ('accounts')|_ }}
                            </h4>
                            
                            <div class="row">
                                {% for template in templates %}
                                    <div class="col-md-6 col-lg-4" style="margin-bottom: 15px;">
                                        <div class="box template-card" style="cursor: pointer; min-height: 200px;" data-template-name="{{ template.name }}">
                                            <div class="box-body">
                                                <h5>
                                                    <span class="fa fa-{{ template.category.name == 'Asset' ? 'money' : (template.category.name == 'Liability' ? 'landmark' : 'chart-line') }}"></span>
                                                    {{ template.name }}
                                                </h5>
                                                <p class="text-muted small">
                                                    {{ template.description }}
                                                </p>
                                                {% if template.firefly_mapping.account_fields %}
                                                    <div style="margin-top: 10px;">
                                                        <small class="text-info">
                                                            <span class="fa fa-info-circle"></span>
                                                            {{ ('configured_fields')|_ }}: {{ template.firefly_mapping.account_fields|keys|slice(0, 3)|join(', ') }}
                                                            {% if template.firefly_mapping.account_fields|keys|length > 3 %}
                                                                +{{ template.firefly_mapping.account_fields|keys|length - 3 }} {{ ('more')|_ }}
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="box-footer">
                                                <div class="row">
                                                    <div class="col-xs-6">
                                                        <button class="btn btn-primary btn-sm btn-block" data-template-name="{{ template.name }}">
                                                            <span class="fa fa-plus"></span>
                                                            {{ ('create_account')|_ }}
                                                        </button>
                                                    </div>
                                                    <div class="col-xs-6">
                                                        <button class="btn btn-default btn-sm btn-block edit-template-btn" data-template-id="{{ template.id }}" data-template-name="{{ template.name }}">
                                                            <span class="fa fa-edit"></span>
                                                            {{ ('edit')|_ }}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                <!-- Custom Account Option -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <h4 class="text-muted">
                        <span class="fa fa-cog"></span>
                        {{ ('custom_options')|_ }}
                    </h4>
                    <div class="row">
                        <div class="col-md-6 col-lg-4" style="margin-bottom: 15px;">
                            <div class="box text-center" style="min-height: 150px;">
                                <div class="box-body">
                                    <h5>
                                        <span class="fa fa-plus-circle"></span>
                                        {{ ('custom_asset_account')|_ }}
                                    </h5>
                                    <p class="text-muted">
                                        {{ ('create_custom_asset_description')|_ }}
                                    </p>
                                </div>
                                <div class="box-footer">
                                    <a href="{{ route('accounts.create', 'asset') }}" class="btn btn-default btn-sm btn-block">
                                        <span class="fa fa-plus"></span>
                                        {{ ('create_custom')|_ }}
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-4" style="margin-bottom: 15px;">
                            <div class="box text-center" style="min-height: 150px;">
                                <div class="box-body">
                                    <h5>
                                        <span class="fa fa-landmark"></span>
                                        {{ ('custom_liability_account')|_ }}
                                    </h5>
                                    <p class="text-muted">
                                        {{ ('create_custom_liability_description')|_ }}
                                    </p>
                                </div>
                                <div class="box-footer">
                                    <a href="{{ route('accounts.create', 'liabilities') }}" class="btn btn-default btn-sm btn-block">
                                        <span class="fa fa-plus"></span>
                                        {{ ('create_custom')|_ }}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template Edit Modal -->
<div class="modal fade" id="editTemplateModal" tabindex="-1" role="dialog" aria-labelledby="editTemplateModalLabel">
    <div class="modal-dialog" role="document" style="width: 95%; max-width: 1400px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="{{ ('close')|_ }}">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="editTemplateModalLabel">
                    <span class="fa fa-edit"></span>
                    {{ ('edit_template')|_ }}: <span id="templateName"></span>
                </h4>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="editTemplateForm">
                    <input type="hidden" id="templateId" name="template_id">
                    
                    <!-- Template Basic Info -->
                    <div class="row" style="margin-bottom: 20px;">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="templateLabel">{{ ('template_label')|_ }}</label>
                                <input type="text" class="form-control" id="templateLabel" name="label" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="templateDescription">{{ ('description')|_ }}</label>
                                <textarea class="form-control" id="templateDescription" name="description" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Field Management -->
                    <div class="row">
                        <div class="col-md-12">
                            <h5>{{ ('field_management')|_ }}</h5>
                            <p class="text-muted">{{ ('manage_which_fields_are_included_in_this_template')|_ }}</p>
                            
                            <!-- Search and Filter Controls -->
                            <div class="row" style="margin-bottom: 15px;">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="fieldSearch" placeholder="{{ ('search_fields')|_ }}">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="fieldCategoryFilter">
                                        <option value="">{{ ('all_categories')|_ }}</option>
                                        <option value="basic_info">{{ ('basic_info')|_ }}</option>
                                        <option value="financial">{{ ('financial')|_ }}</option>
                                        <option value="features">{{ ('features')|_ }}</option>
                                        <option value="investment">{{ ('investment')|_ }}</option>
                                        <option value="digital">{{ ('digital')|_ }}</option>
                                        <option value="fees">{{ ('fees')|_ }}</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="showUnusedFields"> {{ ('display_unused_fields')|_ }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fields Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered" id="fieldsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 8%; text-align: center;">{{ ('active')|_ }}</th>
                                            <th style="width: 25%;">{{ ('field_name')|_ }}</th>
                                            <th style="width: 30%;">{{ ('description')|_ }}</th>
                                            <th style="width: 12%;">{{ ('category')|_ }}</th>
                                            <th style="width: 10%; text-align: center;">{{ ('required')|_ }}</th>
                                            <th style="width: 15%;">{{ ('default_value')|_ }}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fieldsTableBody">
                                        <!-- Content will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    {{ ('cancel')|_ }}
                </button>
                <button type="button" class="btn btn-primary" id="saveTemplateBtn" disabled>
                    <span class="fa fa-save"></span>
                    {{ ('save_changes')|_ }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ asset('js/field-input-renderer.js') }}" nonce="{{ JS_NONCE }}"></script>
<script type="text/javascript" nonce="{{ JS_NONCE }}">
// Make translations available to JavaScript
window.translations = {
    template_updated_successfully: "{{ ('template_updated_successfully')|_ }}",
    error_updating_template: "{{ ('error_updating_template')|_ }}",
    error_saving_template: "{{ ('error_saving_template')|_ }}",
    loading_field_definitions: "{{ ('loading_field_definitions')|_ }}",
    field_definitions_loaded: "{{ ('field_definitions_loaded')|_ }}",
    error_loading_field_definitions: "{{ ('error_loading_field_definitions')|_ }}",
    loading_template_data: "{{ ('loading_template_data')|_ }}",
    template_data_loaded: "{{ ('template_data_loaded')|_ }}",
    error_loading_template_data: "{{ ('error_loading_template_data')|_ }}",
    field_definitions_not_loaded: "{{ ('field_definitions_not_loaded')|_ }}",
    failed_to_load_field_definitions: "{{ ('failed_to_load_field_definitions')|_ }}",
    failed_to_load_field_definitions_message: "{{ ('failed_to_load_field_definitions_message')|_ }}"
};

document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to template cards
    document.querySelectorAll('.template-card').forEach(function(card) {
        card.addEventListener('click', function() {
            var templateName = this.getAttribute('data-template-name');
            var baseUrl = "/accounts/templates/create/" + encodeURIComponent(templateName);
            window.location.href = baseUrl;
        });
    });
    
    // Add click handlers to buttons (prevent event bubbling)
    document.querySelectorAll('.template-card button').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent card click
            
            if (this.classList.contains('edit-template-btn')) {
                // Handle edit button
                var templateId = this.getAttribute('data-template-id');
                var templateName = this.getAttribute('data-template-name');
                openEditModal(templateId, templateName);
            } else {
                // Handle create button
                var templateName = this.getAttribute('data-template-name');
                openCreateModal(templateName);
            }
        });
    });
    
    // Search and filter functionality
    var searchInput = document.getElementById('search');
    var categorySelect = document.getElementById('category');
    var behaviorSelect = document.getElementById('account_type');
    var sortSelect = document.getElementById('sort');
    
    function updateFilters() {
        var params = new URLSearchParams();
        
        if (searchInput.value) {
            params.set('search', searchInput.value);
        }
        if (categorySelect.value) {
            params.set('category', categorySelect.value);
        }
        if (behaviorSelect.value) {
            params.set('account_type', behaviorSelect.value);
        }
        if (sortSelect.value) {
            params.set('sort', sortSelect.value);
        }
        
        var newUrl = window.location.pathname;
        if (params.toString()) {
            newUrl += '?' + params.toString();
        }
        
        window.location.href = newUrl;
    }
    
    // Add event listeners for real-time filtering
    searchInput.addEventListener('input', function() {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(updateFilters, 500); // Debounce search
    });
    
    categorySelect.addEventListener('change', updateFilters);
    behaviorSelect.addEventListener('change', updateFilters);
    sortSelect.addEventListener('change', updateFilters);
    
    // Clear filters button
    var clearButton = document.createElement('button');
    clearButton.type = 'button';
    clearButton.className = 'btn btn-default btn-sm';
    clearButton.innerHTML = '<span class="fa fa-times"></span> Clear Filters';
    clearButton.style.marginTop = '25px';
    clearButton.addEventListener('click', function() {
        window.location.href = window.location.pathname;
    });
    
    document.querySelector('.col-md-2 .form-group').appendChild(clearButton);
    
    // Edit modal functionality
    var fieldDefinitions = null;
    var currentTemplate = null;
    var configuredFields = {};
    var originalConfiguredFields = {};
    var hasChanges = false;
    
    // Load field definitions when page loads
    loadFieldDefinitions();
    
    // Save template button handler
    document.getElementById('saveTemplateBtn').addEventListener('click', function() {
        saveTemplate();
    });
    
    
    // Show unused fields checkbox handler
    document.getElementById('showUnusedFields').addEventListener('change', function() {
        populateFieldsTable();
    });
    
    // Field search functionality
    document.getElementById('fieldSearch').addEventListener('input', function() {
        filterFields();
    });
    
    // Field category filter
    document.getElementById('fieldCategoryFilter').addEventListener('change', function() {
        filterFields();
    });
    
});

// Function to update button states
function updateButtonStates() {
    var saveBtn = document.getElementById('saveTemplateBtn');
    
    // Check if there are any changes
    hasChanges = JSON.stringify(configuredFields) !== JSON.stringify(originalConfiguredFields);
    
    // Enable/disable Save button based on changes
    saveBtn.disabled = !hasChanges;
    
    // Update Save button appearance
    if (hasChanges) {
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-warning');
    } else {
        saveBtn.classList.remove('btn-warning');
        saveBtn.classList.add('btn-primary');
    }
}

// Function to open edit modal
function openEditModal(templateId, templateName) {
    document.getElementById('templateId').value = templateId;
    document.getElementById('templateName').textContent = templateName;
    
    // Show modal first
    $('#editTemplateModal').modal('show');
    
    // Load template data after modal is shown
    loadTemplateData(templateId);
}

// Function to open create modal
function openCreateModal(templateName) {
    // Load modal once if not already loaded
    if ($('#createAccountModal').length === 0) {
        $.get('/accounts/templates/create-modal/' + encodeURIComponent(templateName))
            .done(function(data) {
                $('body').append(data);
                // Initialize the modal with null ID (for create scenario)
                loadEntityEditModal(null);
            })
            .fail(function() {
                alert('Error loading create modal. Please try again.');
            });
    } else {
        // Modal already exists, just initialize it
        loadEntityEditModal(null);
    }
}

// Function to load field definitions
function loadFieldDefinitions() {
    console.log(window.translations.loading_field_definitions);
    fetch('/accounts/templates/field-definitions')
        .then(response => {
            console.log('Field definitions response status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            fieldDefinitions = data;
            console.log(window.translations.field_definitions_loaded + ':', fieldDefinitions);
        })
        .catch(error => {
            console.error(window.translations.error_loading_field_definitions + ':', error);
            // Try to load a fallback or show error
            fieldDefinitions = null;
        });
}

// Function to load template data
function loadTemplateData(templateId) {
    console.log(window.translations.loading_template_data.replace(':id', templateId));
    fetch('/accounts/templates/' + templateId + '/edit')
        .then(response => {
            console.log('Template data response status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log(window.translations.template_data_loaded + ':', data);
            currentTemplate = data;
            
            // Populate basic info
            document.getElementById('templateLabel').value = data.name || '';
            document.getElementById('templateDescription').value = data.description || '';
            
            // Populate field configuration
            populateFieldConfiguration(data);
        })
        .catch(error => {
            console.error(window.translations.error_loading_template_data + ':', error);
            // Show error in modal
            document.getElementById('fieldCategoryContent').innerHTML = 
                '<div class="alert alert-danger">' + window.translations.error_loading_template_data + ': ' + error.message + '</div>';
        });
}

// Function to populate field configuration
function populateFieldConfiguration(template) {
    if (!fieldDefinitions) {
        console.error(window.translations.field_definitions_not_loaded);
        // Retry loading field definitions
        loadFieldDefinitions();
        // Try again after a short delay
        setTimeout(function() {
            if (fieldDefinitions) {
                populateFieldConfiguration(template);
            } else {
                console.error(window.translations.failed_to_load_field_definitions);
                // Show a message in the modal
                document.getElementById('configuredFieldsTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center"><div class="alert alert-warning">' + window.translations.failed_to_load_field_definitions_message + '</div></td></tr>';
            }
        }, 1000);
        return;
    }
    
    // Store configured fields
    configuredFields = template.account_fields || {};
    originalConfiguredFields = JSON.parse(JSON.stringify(configuredFields)); // Deep copy
    
    // Populate the single fields table
    populateFieldsTable();
    
    // Update button states
    updateButtonStates();
}

// Function to populate the single fields table
function populateFieldsTable() {
    var tableRowsHtml = '';
    var showUnused = document.getElementById('showUnusedFields').checked;
    
    // Sort fields by category and display name
    var sortedFields = fieldDefinitions.sort(function(a, b) {
        if (a.category !== b.category) {
            return a.category.localeCompare(b.category);
        }
        return a.display_name.localeCompare(b.display_name);
    });
    
    sortedFields.forEach(function(field) {
        var isActive = configuredFields[field.field_name] ? true : false;
        var fieldConfig = configuredFields[field.field_name] || { required: false, default: '' };
        
        // Skip inactive fields if not showing unused
        if (!isActive && !showUnused) {
            return;
        }
        
        // Determine row class based on active status
        var rowClass = isActive ? 'field-row-active' : 'field-row-inactive';
        
        tableRowsHtml += '<tr class="' + rowClass + '" data-field="' + field.field_name + '" data-category="' + field.category + '">';
        
        // Active checkbox
        tableRowsHtml += '<td class="text-center">';
        tableRowsHtml += '<input type="checkbox" class="field-active" data-field="' + field.field_name + '" ' + (isActive ? 'checked' : '') + '>';
        tableRowsHtml += '</td>';
        
        // Field name
        tableRowsHtml += '<td><strong>' + field.display_name + '</strong></td>';
        
        // Description
        tableRowsHtml += '<td>' + (field.description || '') + '</td>';
        
        // Category
        tableRowsHtml += '<td>' + field.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + '</td>';
        
        // Required checkbox (only show if active)
        tableRowsHtml += '<td class="text-center">';
        if (isActive) {
            tableRowsHtml += '<input type="checkbox" class="field-required" data-field="' + field.field_name + '" ' + (fieldConfig.required ? 'checked' : '') + '>';
        } else {
            tableRowsHtml += '-';
        }
        tableRowsHtml += '</td>';
        
        // Default value (only show if active)
        tableRowsHtml += '<td>';
        if (isActive) {
            tableRowsHtml += FieldInputRenderer.generateInput(field, field.field_name, fieldConfig.default || '', {
                namePrefix: 'field_default_',
                cssClass: 'form-control input-sm'
            });
        } else {
            tableRowsHtml += '-';
        }
        tableRowsHtml += '</td>';
        
        tableRowsHtml += '</tr>';
    });
    
    document.getElementById('fieldsTableBody').innerHTML = tableRowsHtml;
    
    // Add event listeners
    addFieldEventListeners();
    
    // Load financial entities for dropdowns
    FieldInputRenderer.loadFinancialEntitiesForDropdowns();
}

// Function to get input field preview
function getInputFieldPreview(dataType) {
    switch (dataType.toLowerCase()) {
        case 'boolean':
        case 'bool':
            return '<input type="checkbox" disabled>';
        case 'date':
            return '<input type="date" class="form-control input-sm" disabled>';
        case 'datetime':
        case 'timestamp':
            return '<input type="datetime-local" class="form-control input-sm" disabled>';
        case 'integer':
        case 'int':
            return '<input type="number" class="form-control input-sm" disabled>';
        case 'decimal':
        case 'float':
        case 'double':
            return '<input type="number" class="form-control input-sm" disabled>';
        case 'email':
            return '<input type="email" class="form-control input-sm" disabled>';
        case 'url':
            return '<input type="url" class="form-control input-sm" disabled>';
        case 'tel':
        case 'phone':
            return '<input type="tel" class="form-control input-sm" disabled>';
        case 'textarea':
            return '<textarea class="form-control input-sm" disabled></textarea>';
        case 'text':
        default:
            return '<input type="text" class="form-control input-sm" disabled>';
    }
}

// Function to add event listeners for field interactions
function addFieldEventListeners() {
    // Active checkboxes
    document.querySelectorAll('.field-active').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var fieldName = this.getAttribute('data-field');
            var row = this.closest('tr');
            
            if (this.checked) {
                // Add field to configured fields
                configuredFields[fieldName] = {
                    required: false,
                    default: ''
                };
                // Update row class to active
                row.classList.remove('field-row-inactive');
                row.classList.add('field-row-active');
            } else {
                // Remove field from configured fields
                delete configuredFields[fieldName];
                // Update row class to inactive
                row.classList.remove('field-row-active');
                row.classList.add('field-row-inactive');
            }
            updateButtonStates();
        });
    });
    
    // Required checkboxes
    document.querySelectorAll('.field-required').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var fieldName = this.getAttribute('data-field');
            if (configuredFields[fieldName]) {
                configuredFields[fieldName].required = this.checked;
                updateButtonStates();
            }
        });
    });
    
    // Default value inputs
    document.querySelectorAll('input[name^="field_default_"], textarea[name^="field_default_"]').forEach(function(input) {
        input.addEventListener('input', function() {
            updateButtonStates();
        });
    });
}


// Function to filter fields
function filterFields() {
    var searchTerm = document.getElementById('fieldSearch').value.toLowerCase();
    var categoryFilter = document.getElementById('fieldCategoryFilter').value;
    var rows = document.querySelectorAll('#fieldsTableBody tr[data-field]');
    
    rows.forEach(function(row) {
        var fieldName = row.getAttribute('data-field');
        var category = row.getAttribute('data-category');
        var fieldDef = fieldDefinitions.find(function(f) { return f.field_name === fieldName; });
        
        var matchesSearch = !searchTerm || 
            fieldName.toLowerCase().includes(searchTerm) ||
            (fieldDef && fieldDef.display_name.toLowerCase().includes(searchTerm)) ||
            (fieldDef && fieldDef.description && fieldDef.description.toLowerCase().includes(searchTerm));
        
        var matchesCategory = !categoryFilter || category === categoryFilter;
        
        if (matchesSearch && matchesCategory) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}


// Function to save template
function saveTemplate() {
    var templateId = document.getElementById('templateId').value;
    var name = document.getElementById('templateLabel').value;
    var description = document.getElementById('templateDescription').value;
    
    // Collect field configurations from configured fields
    var accountFields = {};
    
    Object.keys(configuredFields).forEach(function(fieldName) {
        var fieldConfig = configuredFields[fieldName];
        var defaultInput = document.querySelector('input[name="field_default_' + fieldName + '"], textarea[name="field_default_' + fieldName + '"]');
        
        var defaultValue = '';
        if (defaultInput) {
            // Handle different input types
            if (defaultInput.type === 'checkbox') {
                defaultValue = defaultInput.checked ? '1' : '0';
            } else if (defaultInput.type === 'number') {
                defaultValue = defaultInput.value || '0';
            } else if (defaultInput.type === 'date' || defaultInput.type === 'datetime-local') {
                defaultValue = defaultInput.value || '';
            } else {
                defaultValue = defaultInput.value || '';
            }
        }
        
        accountFields[fieldName] = {
            required: fieldConfig.required,
            default: defaultValue
        };
    });
    
    var data = {
        name: name,
        description: description,
        account_fields: accountFields
    };
    
    
    // Show loading state
    var saveBtn = document.getElementById('saveTemplateBtn');
    var originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="fa fa-spinner fa-spin"></span> Saving...';
    saveBtn.disabled = true;
    
    // Send request
    fetch('/accounts/templates/' + templateId, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
                        alert(window.translations.template_updated_successfully);
            
            // Reset change tracking
            originalConfiguredFields = JSON.parse(JSON.stringify(configuredFields));
            hasChanges = false;
            updateButtonStates();
            
            $('#editTemplateModal').modal('hide');
            // Reload page to show changes
            window.location.reload();
        } else {
                        alert(window.translations.error_updating_template.replace(':message', data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving template:', error);
        alert(window.translations.error_saving_template);
    })
    .finally(function() {
        // Restore button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}
</script>

<style>
.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

/* Field row styling - work with Bootstrap striping */
.field-row-inactive {
    color: #999 !important;
    opacity: 0.7;
}

.field-row-inactive td {
    color: #999 !important;
}

.field-row-inactive strong {
    color: #666 !important;
}

/* Keep Bootstrap striping for active rows */
.field-row-active {
    /* Let Bootstrap handle the striping */
}

/* When inactive row becomes active, restore normal colors */
.field-row-inactive.field-row-active {
    color: inherit !important;
    opacity: 1;
}

.field-row-inactive.field-row-active td {
    color: inherit !important;
}

.field-row-inactive.field-row-active strong {
    color: inherit !important;
}
</style>
{% endblock %}
